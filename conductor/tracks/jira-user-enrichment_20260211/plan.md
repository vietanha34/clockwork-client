# Implementation Plan: Jira User Enrichment for Active Timers

**Track ID:** jira-user-enrichment_20260211
**Spec:** [spec.md](./spec.md)
**Created:** 2026-02-11
**Status:** [ ] Not Started

## Overview

Add a Jira user resolution layer: `atlassian-client.ts` gains a `getJiraUser` function, `redis.ts` gains get/set helpers with 2-day TTL, and `sync-active-timers.ts` enriches timer authors before grouping and caching.

---

## Phase 1: Jira User API + Redis Cache Helpers

Add the low-level building blocks.

### Tasks

- [x] Task 1.1: Add `RawJiraUser` interface and `getJiraUser(accountId)` function to `atlassian-client.ts` — calls `GET /rest/api/3/user?accountId=<id>` and returns `ClockworkUser`
- [x] Task 1.2: Add `getCachedJiraUser(accountId)` and `setCachedJiraUser(accountId, user)` to `redis.ts` — key `jira:user:<accountId>`, TTL = 172800 s (2 days)
- [x] Task 1.3: Add `JiraUserCache` type to `types.ts` if needed (or reuse `ClockworkUser`)

### Verification

- [ ] TypeScript compiles cleanly (`pnpm typecheck` passes in `apps/api`)

---

## Phase 2: resolveTimerAuthors Helper

Build the orchestration logic that ties cache + API together.

### Tasks

- [x] Task 2.1: Create `resolveTimerAuthor(accountId: string): Promise<ClockworkUser | null>` in `apps/api/src/lib/jira-user-resolver.ts` — check Redis cache first, fall back to Jira API, write to cache, return result (or null on error)
- [x] Task 2.2: Create `resolveTimerAuthors(timers: RawTimer[]): Promise<Timer[]>` — deduplicates accountIds, calls `resolveTimerAuthor` in parallel, maps results back onto each timer's `author` field

### Verification

- [ ] TypeScript compiles cleanly

---

## Phase 3: Wire into sync-active-timers

Replace the current inline author mapping with the enriched resolver.

### Tasks

- [x] Task 3.1: In `sync-active-timers.ts`, replace the `allEntries` map block with a call to `resolveTimerAuthors(timers)` — remove the `emailAddress ?? ''` fallback
- [x] Task 3.2: Update `RawClockworkTimer` in `types.ts` to add optional `author` field (align with `RawTimer` in `clockwork-report.ts`) — eliminates the type inconsistency
- [x] Task 3.3: Verify timer grouping by email still works; log a warning for any timer whose author could not be resolved

### Verification

- [ ] `pnpm typecheck` passes across the monorepo
- [ ] `pnpm lint` passes
- [ ] Manual test: trigger `clockwork/timers.sync.requested` via Inngest dev server, confirm Redis contains timers with populated `author.emailAddress`

---

## Phase 4: Environment + Docs

### Tasks

- [x] Task 4.1: Verify `ATLASSIAN_EMAIL`, `ATLASSIAN_API_TOKEN`, `JIRA_DOMAIN` are documented in `apps/api/.env.example` (add if missing)
- [x] Task 4.2: Update `docs/deployment.md` with a note about the Jira user cache key pattern (`jira:user:<accountId>`, 2-day TTL)

### Verification

- [ ] All acceptance criteria from spec.md checked off

---

## Final Verification

- [ ] All acceptance criteria met
- [ ] Tests passing / type-check clean
- [ ] Documentation updated
- [ ] Ready for review

---

_Generated by Conductor. Tasks will be marked [~] in progress and [x] complete._
