# Implementation Plan: Switch Primary Key from Email to accountId

**Track ID:** accountid-primary-key_20260211
**Spec:** [spec.md](./spec.md)
**Design:** [design doc](../../../docs/plans/2026-02-11-accountid-primary-key-design.md)
**Created:** 2026-02-11
**Status:** [~] In Progress

## Overview

Four phases: (1) server-side building blocks, (2) new resolve endpoint, (3) Inngest sync fix, (4) Tauri client update.

---

## Phase 1: Server-side Helpers

Add the low-level pieces needed by all other phases.

### Tasks

- [x] Task 1.1: Add `searchJiraUserByEmail(email)` to `atlassian-client.ts` — calls `GET /rest/api/3/user/search?query=<email>&maxResults=1`, returns first exact-email-match as `ClockworkUser`
- [x] Task 1.2: Add `getCachedEmailToAccountId(email)` and `setCachedEmailToAccountId(email, accountId)` to `redis.ts` — key `jira:email:<email>`, TTL 172800 s (2 days)
- [x] Task 1.3: Update `TIMER_KEY_PREFIX` usage in `redis.ts` — change timer key from `clockwork:timers:<email>` to `clockwork:timers:<accountId>` (rename param from `userEmail` to `userKey` or `accountId`)

### Verification

- [x] `pnpm type-check` passes in `apps/api`

---

## Phase 2: Resolve Endpoint

Expose email → accountId resolution to clients.

### Tasks

- [ ] Task 2.1: Create `apps/api/api/users/resolve.ts` — `GET /api/users/resolve?email=<email>`, check Redis cache, fallback to `searchJiraUserByEmail`, cache result, return `{ accountId, emailAddress, displayName }`
- [ ] Task 2.2: Update `apps/api/api/timers/active.ts` — change query param from `userEmail` to `accountId`

### Verification

- [ ] `pnpm type-check` passes
- [ ] `pnpm lint` passes

---

## Phase 3: Inngest Sync Fix

Fix the root cause — group timers by accountId instead of email.

### Tasks

- [ ] Task 3.1: In `sync-active-timers.ts`, change grouping loop to use `entry.runningFor` (accountId) as key instead of `entry.author?.emailAddress`
- [ ] Task 3.2: In `setActiveTimers` calls, pass `accountId` (from `runningFor`) as the key

### Verification

- [ ] `pnpm type-check` passes
- [ ] `pnpm lint` passes
- [ ] Manual: trigger sync, verify Redis contains `clockwork:timers:<accountId>` keys

---

## Phase 4: Tauri Client Update

Update the desktop app to resolve and store accountId, then use it for queries.

### Tasks

- [ ] Task 4.1: Add `userAccountId: string` to `AppSettings` interface in `apps/tauri/src/lib/types.ts` and update `DEFAULT_SETTINGS`
- [ ] Task 4.2: Add `user_account_id` field (with `#[serde(default)]`) to Rust `AppSettings` struct in `src-tauri/src/lib.rs`
- [ ] Task 4.3: Add `resolveUserAccountId(apiBaseUrl, email)` function to `api-client.ts` — calls `GET /api/users/resolve?email=<email>`
- [ ] Task 4.4: Update `SettingsView.tsx` — after saving settings, call `resolveUserAccountId` and persist the returned `accountId`; show warning toast if resolution fails
- [ ] Task 4.5: Update `useActiveTimers.ts` — use `settings.userAccountId` instead of `settings.userEmail` for the API call
- [ ] Task 4.6: Add empty-accountId guard in `useActiveTimers.ts` — if `userAccountId` is empty, skip fetch and return nudge state

### Verification

- [ ] `pnpm type-check` passes in `apps/tauri`
- [ ] `pnpm lint` passes
- [ ] Manual: open Settings → save email → verify accountId is stored → close/reopen app → timers load correctly

---

## Final Verification

- [ ] All acceptance criteria from spec.md met
- [ ] Type-check clean across monorepo
- [ ] Lint clean
- [ ] Deploy order documented: api → inngest → client re-save settings

---

_Generated by Conductor. Tasks will be marked [~] in progress and [x] complete._
