# Implementation Plan: Client-Side Clockwork API Token

**Track ID:** client-token_20260213
**Spec:** [spec.md](./spec.md)
**Created:** 2026-02-13
**Status:** [ ] Not Started

## Overview

Add `clockworkApiToken` to Tauri client settings, send it via `X-Clockwork-Token` header on API calls, and update the server to extract and use the client-provided token with env var fallback.

## Phase 1: Tauri Client Settings

Extend the settings model and UI to support the new token field.

### Tasks

- [x] Task 1.1: Add `clockworkApiToken` field to TypeScript `AppSettings` interface and `DEFAULT_SETTINGS` in `apps/tauri/src/lib/types.ts`
- [x] Task 1.2: Add `clockwork_api_token` field to Rust `AppSettings` struct in `apps/tauri/src-tauri/src/lib.rs`
- [ ] Task 1.3: Add "Clockwork API Token" input field to `SettingsView.tsx` (password-masked input)

### Verification

- [ ] Settings UI shows the new token field, value persists after save and reload

## Phase 2: Tauri API Client â€” Send Token Header

Update the Tauri HTTP client to include the token on outbound requests.

### Tasks

- [ ] Task 2.1: Update `apiFetch` or `startTimer` in `apps/tauri/src/lib/api-client.ts` to accept and send `X-Clockwork-Token` header
- [ ] Task 2.2: Update the call site (e.g., `useTimerActions.ts` or wherever `startTimer` is invoked) to pass the token from settings context

### Verification

- [ ] Start timer request includes `X-Clockwork-Token` header (verify via network log or curl debug)

## Phase 3: Server-Side Token Extraction

Update the API route and clockwork-client to accept token from the request header.

### Tasks

- [ ] Task 3.1: Update `clockworkFetch` in `apps/api/src/lib/clockwork-client.ts` to accept an optional `token` parameter, falling back to `env.CLOCKWORK_API_TOKEN`
- [ ] Task 3.2: Update `startTimer` in `clockwork-client.ts` to pass through the optional token
- [ ] Task 3.3: Update `/api/timers/start` route to extract `X-Clockwork-Token` header and pass it to `startTimer`

### Verification

- [ ] Start timer works end-to-end with client-provided token
- [ ] Start timer still works with env var fallback when no header is sent

## Final Verification

- [ ] All acceptance criteria met
- [ ] No regressions in existing timer functionality (stop timer, active timers)
- [ ] Settings persist across app restart

---

_Generated by Conductor. Tasks will be marked [~] in progress and [x] complete._
